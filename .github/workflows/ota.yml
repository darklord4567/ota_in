name: OnePlus OTA Split Pipeline

on:
  workflow_dispatch:
    inputs:
      ota_url:
        description: "Direct OTA link"
        required: true
      tag:
        description: "Release Tag (ex: N4-14.320-IND)"
        required: true

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # FREE DISK
      # -------------------------------------------------
      - name: üßπ Free Disk Space (Aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/powershell || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: üì¶ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full jq gh

      # -------------------------------------------------
      # DM: START
      # -------------------------------------------------
      - name: üí¨ DM ‚Äî Pipeline Started
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="üöÄ *Pipeline Started*\nTag: *${{ github.event.inputs.tag }}*" \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # DM: DOWNLOAD STARTING
      # -------------------------------------------------
      - name: üí¨ DM ‚Äî Download Starting
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚¨áÔ∏è Starting download..."

      # -------------------------------------------------
      # DOWNLOAD WITH 5% PROGRESS (NO 100%)
      # -------------------------------------------------
      - name: ‚¨áÔ∏è Download OTA (with progress)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
          URL: ${{ github.event.inputs.ota_url }}
        run: |
          aria2c "$URL" -x16 -s16 -k1M -o ota.zip &
          PID=$!

          Total=$(curl -sI "$URL" | grep -i content-length | awk '{print $2}' | tr -d '\r')
          [ -z "$Total" ] && Total=0

          Last=0
          while kill -0 $PID 2>/dev/null; do
            if [ -f ota.zip ] && [ "$Total" -gt 0 ]; then
              Done=$(stat -c%s ota.zip)
              Pct=$((100 * Done / Total))
              Step=$((Pct / 5))

              if [ "$Step" -ne "$Last" ] && [ "$Pct" -lt 100 ]; then
                Bars=$(printf "%0.s‚ñà" $(seq 1 $Step))
                Spaces=$(printf "%0.s-" $(seq 1 $((20-Step))))
                curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                  -d chat_id="$TG_DM" \
                  -d text="‚¨áÔ∏è *Download Progress*\n\`[$Bars$Spaces] $Pct%%\`" \
                  -d parse_mode="Markdown"
                Last=$Step
              fi
            fi
            sleep 2
          done

      - name: üí¨ DM ‚Äî Download Finished
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          SIZE=$(du -h ota.zip | cut -f1)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚úÖ Download Finished\nSize: *$SIZE*" \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # RENAME + SPLIT
      # -------------------------------------------------
      - name: Rename OTA to TAG.zip
        run: |
          mv ota.zip "${{ github.event.inputs.tag }}.zip"

      - name: üí¨ DM ‚Äî Split Starting
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚úÇÔ∏è Starting 7z split..."

      - name: ‚úÇÔ∏è Split Using 7z (No Recompression)
        run: |
          7z a -t7z -mx=0 -v1990m "${{ github.event.inputs.tag }}.7z" "${{ github.event.inputs.tag }}.zip"

      - name: üí¨ DM ‚Äî Split Finished
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          PARTS=$(ls ${{ github.event.inputs.tag }}.7z.* | wc -l)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚úÖ *Split Finished*\nParts created: *$PARTS*" \
            -d parse_mode="Markdown"

      # -------------------------------------------------
      # REQUIRED CHECKOUT BEFORE GH CLI
      # -------------------------------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # -------------------------------------------------
      # FIXED RELEASE CREATION (NO 404 + NO .git ERROR)
      # -------------------------------------------------
      - name: üì§ Ensure GitHub Release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG"
          else
            echo "Creating release: $TAG"
            gh release create "$TAG" -t "$TAG" -n "Automatic OTA Split Release"
          fi

      # -------------------------------------------------
      # FIXED MULTI-FILE UPLOAD TO RELEASE
      # -------------------------------------------------
      - name: üì§ Upload Split Parts to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/$TAG --jq '.id')

          for f in $TAG.7z.*; do
            echo "Uploading $f ..."
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/octet-stream" \
              /repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$(basename "$f") \
              --input "$f"
          done

      # -------------------------------------------------
      # TELEGRAM UPLOAD
      # -------------------------------------------------
      - name: üì° Upload to Telegram Channel
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          i=1
          for f in ${{ github.event.inputs.tag }}.7z.*; do
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="üì° Uploading part $i..." \
              -d parse_mode="Markdown"

            curl -s -F chat_id="$TG_CHAT" -F document=@"$f" \
              https://api.telegram.org/bot$TG_TOKEN/sendDocument

            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚úîÔ∏è Part $i uploaded." \
              -d parse_mode="Markdown"
            i=$((i+1))
          done

      # -------------------------------------------------
      # DM: SUCCESS
      # -------------------------------------------------
      - name: üéâ DM ‚Äî Pipeline Completed
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="üéâ *Pipeline Completed Successfully!*" \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # DM: FAILURE (FIXED)
      # -------------------------------------------------
      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚ùå *Pipeline FAILED!* Check GitHub Actions logs." \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # CLEANUP
      # -------------------------------------------------
      - name: üßπ Cleanup
        if: ${{ always() }}
        run: |
          rm -rf *.zip *.7z.* ota.zip
          echo "Cleanup complete."
