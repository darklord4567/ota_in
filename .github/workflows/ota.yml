name: OnePlus OTA Split Pipeline

on:
  workflow_dispatch:
    inputs:
      ota_url:
        description: "Direct OTA link"
        required: true
      tag:
        description: "Release Tag (ex: N4-14.320-IND)"
        required: true

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1. CHECKOUT FIRST
      # -------------------------------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # -------------------------------------------------
      # 2. FREE DISK
      # -------------------------------------------------
      - name: üßπ Free Disk Space (Aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/powershell || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: üì¶ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full jq gh
          # Install Python dependencies for Telegram Upload
          pip install pyrogram tgcrypto

      # -------------------------------------------------
      # DM: START
      # -------------------------------------------------
      - name: üí¨ DM ‚Äî Pipeline Started
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="üöÄ *Pipeline Started*\nTag: *${{ github.event.inputs.tag }}*" \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # DOWNLOAD
      # -------------------------------------------------
      - name: üí¨ DM ‚Äî Download Starting
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚¨áÔ∏è Starting download..."

      - name: ‚¨áÔ∏è Download OTA (with progress)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
          URL: ${{ github.event.inputs.ota_url }}
        run: |
          aria2c "$URL" -x16 -s16 -k1M -o ota.zip &
          PID=$!

          Total=$(curl -sI "$URL" | grep -i content-length | awk '{print $2}' | tr -d '\r')
          [ -z "$Total" ] && Total=0

          Last=0
          while kill -0 $PID 2>/dev/null; do
            if [ -f ota.zip ] && [ "$Total" -gt 0 ]; then
              Done=$(stat -c%s ota.zip)
              Pct=$((100 * Done / Total))
              Step=$((Pct / 5))

              if [ "$Step" -ne "$Last" ] && [ "$Pct" -lt 100 ]; then
                Bars=$(printf "%0.s‚ñà" $(seq 1 $Step))
                Spaces=$(printf "%0.s-" $(seq 1 $((20-Step))))
                curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                  -d chat_id="$TG_DM" \
                  -d text="‚¨áÔ∏è *Download Progress*\n\`[$Bars$Spaces] $Pct%%\`" \
                  -d parse_mode="Markdown"
                Last=$Step
              fi
            fi
            sleep 2
          done

      - name: üí¨ DM ‚Äî Download Finished
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          if [ ! -f ota.zip ]; then
             echo "‚ùå Error: ota.zip not found"
             exit 1
          fi
          SIZE=$(du -h ota.zip | cut -f1)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚úÖ Download Finished\nSize: *$SIZE*" \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # RENAME + SPLIT INTO DIRECTORY
      # -------------------------------------------------
      - name: Rename OTA
        run: mv ota.zip "${{ github.event.inputs.tag }}.zip"

      - name: üí¨ DM ‚Äî Split Starting
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚úÇÔ∏è Starting 7z split..."

      - name: ‚úÇÔ∏è Split Using 7z (Into 'split_output' folder)
        run: |
          mkdir -p split_output
          # Lowered split size slightly to 1900m to be safe within 2GB limit
          7z a -t7z -mx=0 -v1900m "split_output/${{ github.event.inputs.tag }}.7z" "${{ github.event.inputs.tag }}.zip"

      - name: üí¨ DM ‚Äî Split Finished
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          COUNT=$(ls split_output/* | wc -l)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚úÖ *Split Finished*\nParts created: *$COUNT*" \
            -d parse_mode="Markdown"

      # -------------------------------------------------
      # CREATE RELEASE
      # -------------------------------------------------
      - name: üì§ Ensure GitHub Release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG"
          else
            echo "Creating release: $TAG"
            gh release create "$TAG" -t "$TAG" -n "Automatic OTA Split Release"
          fi

      # -------------------------------------------------
      # UPLOAD TO GITHUB
      # -------------------------------------------------
      - name: üì§ Upload Split Parts to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          for f in split_output/*; do
            echo "Uploading $f ..."
            gh release upload "$TAG" "$f" --clobber
          done

      # -------------------------------------------------
      # UPLOAD TO TELEGRAM (PYTHON + PYROGRAM)
      # -------------------------------------------------
      - name: üì° Upload to Telegram (Pyrogram)
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          # We write the python script on the fly
          cat <<EOF > upload_tg.py
          import os
          import glob
          import asyncio
          from pyrogram import Client
          
          # Get environment variables
          api_id = os.environ.get("TG_API_ID")
          api_hash = os.environ.get("TG_API_HASH")
          bot_token = os.environ.get("TG_TOKEN")
          chat_id_str = os.environ.get("TG_CHAT")
          dm_id_str = os.environ.get("TG_DM")

          # Convert chat IDs to integers
          try:
              chat_id = int(chat_id_str)
              dm_id = int(dm_id_str)
          except ValueError:
              print("Error: TG_CHAT or TG_DM must be valid integers.")
              exit(1)

          app = Client("my_bot", api_id=api_id, api_hash=api_hash, bot_token=bot_token)

          async def progress(current, total):
              # Optional: You could implement a progress bar here, 
              # but printing too much clogs Actions logs.
              pass

          async def main():
              async with app:
                  files = sorted(glob.glob("split_output/*"))
                  i = 1
                  for file in files:
                      fname = os.path.basename(file)
                      print(f"Uploading {fname}...")
                      
                      # Notify DM
                      await app.send_message(dm_id, f"üì° Uploading part {i}: {fname}")
                      
                      # Upload Document (Supports up to 2GB)
                      await app.send_document(
                          chat_id=chat_id, 
                          document=file, 
                          caption=f"üì¶ Part {i}: \`{fname}\`",
                          progress=progress
                      )
                      
                      # Notify DM Success
                      await app.send_message(dm_id, f"‚úîÔ∏è Part {i} uploaded.")
                      i += 1

          if __name__ == "__main__":
              app.run(main())
          EOF

          # Run the script
          python3 upload_tg.py

      # -------------------------------------------------
      # DM: SUCCESS
      # -------------------------------------------------
      - name: üéâ DM ‚Äî Pipeline Completed
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="üéâ *Pipeline Completed Successfully!*" \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # DM: FAILURE
      # -------------------------------------------------
      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚ùå *Pipeline FAILED!* Check GitHub Actions logs." \
          -d parse_mode="Markdown"

      # -------------------------------------------------
      # CLEANUP
      # -------------------------------------------------
      - name: üßπ Cleanup
        if: ${{ always() }}
        run: |
          rm -rf split_output *.zip ota.zip upload_tg.py my_bot.session
          echo "Cleanup complete."
