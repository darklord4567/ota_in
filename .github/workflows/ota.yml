name: OnePlus OTA Split Pipeline

on:
  workflow_dispatch:
    inputs:
      ota_url:
        description: "Direct OTA download link"
        required: true
      tag:
        description: "Release Tag (ex: N4-14.320-IND)"
        required: true

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: üßπ Free Disk Space (Aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: üì¶ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full jq

      # -----------------------------
      # DM: Pipeline Start
      # -----------------------------
      - name: üí¨ DM ‚Äî Pipeline Started
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="üöÄ *OTA Pipeline Started*\nTag: *${{ github.event.inputs.tag }}*" \
            -d parse_mode="Markdown"

      # -----------------------------
      # DOWNLOAD + PROGRESS
      # -----------------------------
      - name: üí¨ DM ‚Äî Download Starting
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚¨áÔ∏è Starting download..."

      - name: ‚¨áÔ∏è Download with Progress
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
          URL: ${{ github.event.inputs.ota_url }}
        run: |
          aria2c "$URL" -x16 -s16 -k1M -o ota.zip &
          PID=$!

          Total=$(curl -sI "$URL" | grep -i content-length | awk '{print $2}' | tr -d '\r')
          [ -z "$Total" ] && Total=0

          Last=0
          while kill -0 $PID 2>/dev/null; do
            if [ -f ota.zip ] && [ "$Total" -gt 0 ]; then
              Done=$(stat -c%s ota.zip)
              Pct=$((100 * Done / Total))
              Step=$((Pct / 5))

              if [ "$Step" -ne "$Last" ]; then
                Bars=$(printf "%0.s‚ñà" $(seq 1 $Step))
                Spaces=$(printf "%0.s-" $(seq 1 $((20-Step))))
                curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                  -d chat_id="$TG_DM" \
                  -d text="‚¨áÔ∏è *Download Progress*\n\`[$Bars$Spaces] $Pct%%\`" \
                  -d parse_mode="Markdown"
                Last=$Step
              fi
            fi
            sleep 2
          done

      - name: üí¨ DM ‚Äî Download Finished
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          SIZE=$(du -h ota.zip | cut -f1)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚úÖ Download Finished.\nSize: *$SIZE*" \
          -d parse_mode="Markdown"

      # -------------------------------
      # 7Z SPLIT (NO PROGRESS, ONLY START + END)
      # -------------------------------
      - name: Rename OTA to Tag
        run: |
          mv ota.zip "${{ github.event.inputs.tag }}.zip"

      - name: üí¨ DM ‚Äî Split Starting
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚úÇÔ∏è Starting 7z split..."

      - name: ‚úÇÔ∏è Split Using 7z (No Recompression)
        run: |
          7z a -t7z -mx=0 -v1990m "${{ github.event.inputs.tag }}.7z" "${{ github.event.inputs.tag }}.zip"

      - name: üí¨ DM ‚Äî Split Finished
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          PARTS=$(ls ${{ github.event.inputs.tag }}.7z.* | wc -l)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚úÖ *Split Finished*\nParts created: *$PARTS*" \
            -d parse_mode="Markdown"

      # -------------------------------
      # GITHUB RELEASE UPLOAD
      # -------------------------------
      - name: üì§ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì§ Upload Parts to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          files: ${{ github.event.inputs.tag }}.7z.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # TELEGRAM UPLOAD
      # -------------------------------
      - name: üì° Upload to Telegram Channel
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          i=1
          for f in ${{ github.event.inputs.tag }}.7z.*; do
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="üì° Uploading part $i..." \
              -d parse_mode="Markdown"

            curl -s -F chat_id="$TG_CHAT" -F document=@"$f" \
              https://api.telegram.org/bot$TG_TOKEN/sendDocument

            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚úîÔ∏è Part $i uploaded." \
              -d parse_mode="Markdown"
            i=$((i+1))
          done

      # -------------------------------
      # FINAL DM
      # -------------------------------
      - name: üéâ DM ‚Äî Pipeline Success
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="üéâ *Pipeline Completed Successfully!*" \
            -d parse_mode="Markdown"

      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚ùå Pipeline FAILED. Check logs." \
            -d parse_mode="Markdown"

      # -------------------------------
      # CLEANUP
      # -------------------------------
      - name: üßπ Cleanup
        if: ${{ always() }}
        run: |
          rm -rf *.zip *.7z.* ota.zip
          echo "Cleanup complete."
