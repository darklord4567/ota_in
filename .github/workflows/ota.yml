name: OnePlus OTA Direct Split Pipeline

on:
  workflow_dispatch:
    inputs:
      ota_url:
        description: "Direct OTA download link"
        required: true
      tag:
        description: "Release tag (example: N4-OTA-v1)"
        required: true

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: üßπ Aggressive Disk Cleanup
        run: |
          echo "[INFO] Cleaning up runner disk..."
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/powershell || true
          sudo docker system prune -af || true
          sudo apt-get purge -y google-cloud-cli || true
          sudo apt-get autoremove -y
          echo "[INFO] Cleanup complete."
          df -h

      - name: üì¶ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 jq

      # ------------------------------
      # DM: PIPELINE START
      # ------------------------------

      - name: üì© DM ‚Äî Pipeline Started
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="üöÄ *OTA Pipeline Started*\nTag: *${{ github.event.inputs.tag }}*\nURL received and processing begins..." \
            -d parse_mode="Markdown"

      # ------------------------------
      # DOWNLOAD
      # ------------------------------

      - name: ‚¨áÔ∏è DM ‚Äî Download Starting
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚¨áÔ∏è Starting OTA download..."


      - name: ‚¨áÔ∏è Download OTA with aria2
        run: |
          aria2c "${{ github.event.inputs.ota_url }}" -x16 -s16 -k1M -o ota.zip

      - name: ‚¨áÔ∏è DM ‚Äî Download Finished
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          SIZE=$(du -h ota.zip | cut -f1)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚úÖ Download completed.\nFile size: *$SIZE*" \
            -d parse_mode="Markdown"

      # ------------------------------
      # SPLIT
      # ------------------------------

      - name: ‚úÇÔ∏è Splitting OTA ZIP into 1.99GB parts
        run: |
          split -b 1990M ota.zip ota.part-
          echo "Split complete."

      - name: ‚úÇÔ∏è DM ‚Äî Splitting Progress
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          PARTS=$(ls ota.part-* | wc -l)
          MSG="‚úÇÔ∏è Splitting completed.\nCreated *$PARTS* parts:"
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="$MSG" \
            -d parse_mode="Markdown"

          i=1
          for f in ota.part-*; do
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="üì¶ Part $i created: \`$f\`" \
              -d parse_mode="Markdown"
            i=$((i+1))
          done

      # ------------------------------
      # GITHUB RELEASE
      # ------------------------------

      - name: üì§ Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì§ Upload Parts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          files: ota.part-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì© DM ‚Äî GitHub Release Uploaded
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="üì§ All parts uploaded to *GitHub Release*." \
            -d parse_mode="Markdown"

      # ------------------------------
      # TELEGRAM UPLOAD
      # ------------------------------

      - name: üì° Upload to Telegram Channel
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          i=1
          for f in ota.part-*; do
            curl -s -X POST "https://api.telegram.org/bot$TG_DM/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="üì° Uploading part $i to Telegram..." \
              -d parse_mode="Markdown"

            curl -s -F chat_id="$TG_CHAT" -F document=@"$f" \
              https://api.telegram.org/bot$TG_TOKEN/sendDocument

            curl -s -X POST "https://api.telegram.org/bot$TG_DM/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚úîÔ∏è Uploaded part $i." \
              -d parse_mode="Markdown"
            i=$((i+1))
          done

      # ------------------------------
      # SUCCESS / FAILURE DM
      # ------------------------------

      - name: üéâ DM ‚Äî Pipeline Success
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="üéâ *Pipeline Completed Successfully!*\nTag: *${{ github.event.inputs.tag }}*" \
            -d parse_mode="Markdown"

      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_DM" \
            -d text="‚ùå Pipeline FAILED.\nCheck GitHub Actions logs." \
            -d parse_mode="Markdown"

      # ------------------------------
      # CLEANUP
      # ------------------------------

      - name: üßπ Cleanup Workspace
        if: ${{ always() }}
        run: |
          rm -rf ota.zip ota.part-*
          echo "Cleanup finished."
