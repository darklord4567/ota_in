name: OnePlus Bulk OTA Archiver

on:
  workflow_dispatch:

jobs:
  process_otas:
    runs-on: ubuntu-latest
    steps:
      # -------------------------------------------------
      # 1. CHECKOUT
      # -------------------------------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v3

      # -------------------------------------------------
      # 2. FREE DISK SPACE
      # -------------------------------------------------
      - name: üßπ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      # -------------------------------------------------
      # 3. INSTALL TOOLS
      # -------------------------------------------------
      - name: üì¶ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full

      # -------------------------------------------------
      # 4. PROCESS OTAS (THE LOOP)
      # -------------------------------------------------
      - name: üîÑ Process OTAs Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          # -------------------------------------------------------
          # CONFIGURATION: LIST YOUR OTAS HERE
          # Format: "VERSION|URL"
          # -------------------------------------------------------
          declare -a OTAS=(
            "16.0.1.301|https://gauss-compota-c-in.allawnofs.com/remove-c1a46b248d9776c600b5549133738f98/g-2bd97b941b62b0359aefe0cac446cef5/component-ota/25/11/17/7c846ba95dff4c4097ce68ee86cabee4.zip?sign=7568751380318d05d390afe4dd9031c8&t=69258d94&x-oss-signature=J3wbU09lBha%2FvJmxgu0scc5W5n15%2Bu6rTfRV%2F3laVWQ%3D&x-oss-signature-version=OSS2&x-oss-expires=1764070556&x-oss-access-key-id=LTAI5t7LQqPWs3796pRv6Avx"
          )

          # -------------------------------------------------------
          # START LOOP
          # -------------------------------------------------------
          count=0
          total=${#OTAS[@]}
          
          for item in "${OTAS[@]}"; do
            count=$((count+1))
            
            # Split string
            VERSION="${item%%|*}"
            URL="${item##*|}"
            
            TAG="CPH2661IN-${VERSION}"
            BASE_NAME="CPH2661IN-${VERSION}"
            
            echo "---------------------------------------------------"
            echo "üöÄ Processing [$count/$total]: $TAG"
            echo "---------------------------------------------------"

            # Check if Release exists
            if gh release view "$TAG" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Release $TAG already exists. Skipping..."
              continue
            fi

            # --- DM: DOWNLOAD STARTED ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚¨áÔ∏è *Downloading Started IND * ($count/$total)%0AVersion: \`$VERSION\`" \
              -d parse_mode="Markdown" > /dev/null

            # 2. Download
            echo "‚¨áÔ∏è Downloading..."
            aria2c "$URL" -x16 -s16 -k1M -o ota.zip -q

            # --- DM: ZIPPING ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚úÇÔ∏è *Zipping/Splitting...*" \
              -d parse_mode="Markdown" > /dev/null

            # 3. Split
            echo "‚úÇÔ∏è Splitting..."
            mkdir -p split_output
            7z a -t7z -mx=0 -v1900m "split_output/${BASE_NAME}.7z" "ota.zip"

            # 4. Create Release
            echo "üì¶ Creating GitHub Release..."
            
            # --- NEW RELEASE NOTES FORMAT ---
            NOTES="**Region:** INDIA ( CPH 2661IN ) üáÆüá≥"$'\n'"**Version:** ${VERSION} üì±"$'\n'"**Type:** Official OTA üì¶"$'\n\n'"**BOOT & INIT_BOOT of this ${VERSION} can be found here :** https://t.me/boot_imgs_nord4/2"
            
            gh release create "$TAG" -t "OnePlus OTA - ${VERSION}" -n "$NOTES"

            # 5. Upload Loop (With Start/Done DMs)
            echo "üì§ Uploading assets..."
            part_num=0
            
            # Enable nullglob in case of weird file matches
            shopt -s nullglob
            
            for f in split_output/*; do
               part_num=$((part_num+1))
               fname=$(basename "$f")
               
               # --- DM: UPLOAD START ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="üöÄ *Upload Started*: $fname" \
                -d parse_mode="Markdown" > /dev/null

               # Upload (Force overwrite)
               gh release upload "$TAG" "$f" --clobber
               
               # --- DM: UPLOAD DONE ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="‚úÖ *Upload Done*: $fname" \
                -d parse_mode="Markdown" > /dev/null
            done

            # 6. Cleanup
            echo "üßπ Cleaning up..."
            rm -rf ota.zip split_output
            
            echo "‚úÖ Done with $TAG"
          done
          
          echo "üéâ All tasks finished!"

      # -------------------------------------------------
      # 5. FAILURE NOTIFICATION
      # -------------------------------------------------
      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚ùå *Pipeline FAILED!* Check GitHub Actions logs for details." \
          -d parse_mode="Markdown"
